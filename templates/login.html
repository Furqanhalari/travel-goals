{% extends "base.html" %}

{% block title %}Login - Travel Goals{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/auth.css') }}" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <style>
    .loading {
      opacity: 0.6;
      pointer-events: none;
    }
    .loading::after {
      content: '...';
      animation: dots 1.5s steps(4, end) infinite;
    }
    @keyframes dots {
      0%, 20% { content: '.'; }
      40% { content: '..'; }
      60%, 100% { content: '...'; }
    }
    </style>
{% endblock %}

{% block content %}
  <div class="auth-wrapper">
    <div class="auth-content">
        <!-- Login Card -->
        <div class="login-card">
            <h2>Login to Your Account</h2>
            
            <div id="errorMessage" class="error-message"></div>
            
            <form id="loginForm">
                <div class="input-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" name="username" required placeholder="Enter your username">
                </div>
                
                <div class="input-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" name="password" required placeholder="Enter your password">
                </div>
                
                <div class="form-options">
                    <label class="remember-me">
                        <input type="checkbox" name="remember"> Remember me?
                    </label>
                </div>
                
                <button type="submit" class="btn-login" id="loginBtn">LOGIN</button>
                
                <div class="auth-switch">
                    Don't have an account? <a href="{{ url_for('register_page') }}">Register</a>
                </div>
            </form>
        </div>
        
        <div class="info-side">
            <h1>THE GOAL OF LIFE IS<br>LIVING IN AGREEMENT<br>WITH NATURE.</h1>
            <div class="social-icons">
                <a href="https://facebook.com" target="_blank"><i class="fab fa-facebook"></i></a>
                <a href="https://instagram.com" target="_blank"><i class="fab fa-instagram"></i></a>
                <a href="https://linkedin.com" target="_blank"><i class="fab fa-linkedin"></i></a>
                <a href="https://twitter.com" target="_blank"><i class="fab fa-twitter"></i></a>
            </div>
        </div>
    </div>
  </div>
{% endblock %}

{% block extra_js %}
  <script>
    function showError(message) {
      const errorDiv = document.getElementById('errorMessage');
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
      
      setTimeout(() => {
        errorDiv.style.display = 'none';
      }, 5000);
    }

    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value;
      const errorMessage = document.getElementById('errorMessage');
      const loginBtn = document.getElementById('loginBtn');
      
      errorMessage.style.display = 'none';
      errorMessage.textContent = '';
      
      if (!username || !password) {
        showError('Please fill in all fields');
        return;
      }
      
      // Show loading state
      loginBtn.classList.add('loading');
      loginBtn.disabled = true;
      const originalText = loginBtn.textContent;
      loginBtn.textContent = 'LOGGING IN';
      
      try {
        const response = await fetch('/api/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ username, password })
        });
        
        const data = await response.json();
        
        if (data.success) {
          localStorage.setItem('user', JSON.stringify(data.user));
          console.log('Login successful, user role:', data.user.role);
          
          loginBtn.textContent = 'SUCCESS';
          loginBtn.style.background = 'rgba(40, 167, 69, 0.8)';
          
          setTimeout(() => {
            if (data.user.role === 'admin') {
              window.location.href = '/admin';
            } else {
              window.location.href = '/index';
            }
          }, 500);
        } else {
          showError(data.message || 'Login failed. Please check your credentials.');
          loginBtn.classList.remove('loading');
          loginBtn.disabled = false;
          loginBtn.textContent = originalText;
        }
      } catch (error) {
        console.error('Login error:', error);
        showError('Network error. Please check your connection and try again.');
        loginBtn.classList.remove('loading');
        loginBtn.disabled = false;
        loginBtn.textContent = originalText;
      }
    });

    // Check if already logged in
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        const response = await fetch('/api/session', { credentials: 'include' });
        const data = await response.json();
        if (data.success && data.user) {
          if (data.user.role === 'admin') window.location.href = '/admin';
          else window.location.href = '/index';
        }
      } catch (error) { console.log('Not logged in'); }
    });
  </script>
{% endblock %}